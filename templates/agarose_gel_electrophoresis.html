<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مختبر فصل هلام الأغاروز التفاعلي</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #2563eb;
  --secondary: #10b981;
  --accent: #7c3aed;
  --background: #f0f4f8;
  --foreground: #1e293b;
  --border: #d1d5db;
  --radius: 10px;
  --shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  --step1-color: #3b82f6;
  --step2-color: #10b981;
  --step3-color: #f59e0b;
  --step4-color: #8b5cf6;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Cairo', sans-serif;
}
body {
  zoom: 100% !important;
  background: linear-gradient(135deg, #e6f0fa, #f0f4f8);
  color: var(--foreground);
  height: 100vh;
  width: 100%;
  margin: 0;
  background-image: url('https://www.transparenttextures.com/patterns/white-carbon.png');
  background-size: cover;
  display: flex;
  flex-direction: column;
}
.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - 2rem);
  height: auto;
}
header {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  padding: 0.8rem 1.5rem;
  margin-bottom: 1rem;
  background: rgba(255, 255, 255, 0.95);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.title {
  background: linear-gradient(45deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-size: 2rem;
  font-weight: 700;
}
.main-grid {
  display: grid;
  grid-template-columns: 1.7fr 1fr;
  gap: 1rem;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}
.lab-section {
  background: rgba(255, 255, 255, 0.98);
  border-radius: var(--radius);
  padding: 1.2rem;
  box-shadow: var(--shadow);
  overflow-y: auto;
}
.lab-section:hover {
  transform: translateY(-2px);
}
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 0.8rem;
  margin-bottom: 1rem;
}
.equipment-section {
  background: rgba(241, 245, 249, 0.9);
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 1rem;
}
.tool-card {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.6rem;
  border-radius: var(--radius);
  background: white;
  cursor: grab;
  transition: all 0.3s ease;
  border: 2px solid var(--border);
}
.tool-card:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  border-color: var(--primary);
}
.gel-tray {
  position: relative;
  height: 180px;
  width: 280px;
  margin: 1rem auto;
  background: linear-gradient(to right, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.4));
  border: 3px solid #94a3b8;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.1);
}
.gel {
  position: absolute;
  bottom: 0;
  width: 100%;
  transition: height 1s ease, background 1s ease;
}
.controls {
  background: rgba(241, 245, 249, 0.95);
  padding: 1rem;
  border-radius: var(--radius);
  border: 2px solid var(--border);
}
.protocol-section {
  background: rgba(255, 255, 255, 0.98);
  border-radius: var(--radius);
  padding: 1.2rem;
  box-shadow: var(--shadow);
  overflow-y: auto;
}
.step-card {
  background: white;
  padding: 1rem;
  border-radius: var(--radius);
  border-left: 4px solid var(--border);
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
  margin-bottom: 0.8rem;
}
.step-card.active-step-1 { border-left-color: var(--step1-color); background: #eff6ff; }
.step-card.active-step-2 { border-left-color: var(--step2-color); background: #ecfdf5; }
.step-card.active-step-3 { border-left-color: var(--step3-color); background: #fefce8; }
.step-card.active-step-4 { border-left-color: var(--step4-color); background: #f5f3ff; }
.step-number {
  width: 28px;
  height: 28px;
  background: linear-gradient(45deg, var(--primary), var(--accent));
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-weight: 700;
  margin-left: 0.5rem;
}
.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  text-align: center;
}
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}
.btn:before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s ease, height 0.6s ease;
}
.btn:hover:before {
  width: 300px;
  height: 300px;
}
.btn-primary {
  background: linear-gradient(45deg, var(--primary), var(--accent));
  color: white;
  animation: pulse 2s infinite;
}
.btn-danger {
  background: linear-gradient(45deg, #ef4444, #f87171);
  color: white;
}
.btn-sample {
  background: linear-gradient(45deg, var(--step1-color), #60a5fa);
  color: white;
}
.btn-back {
  background: linear-gradient(45deg, #6b7280, #9ca3af);
  color: white;
}
.btn-equipment {
  background: linear-gradient(45deg, #4b5563, #6b7280);
  color: white;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}
.tooltip {
  position: absolute;
  top: -50px;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 0.6rem 1rem;
  border-radius: 6px;
  font-size: 0.85rem;
  width: 200px;
  text-align: center;
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
}
.tooltip:after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 8px 8px 0;
  border-style: solid;
  border-color: rgba(0, 0, 0, 0.85) transparent transparent;
}
.tool-card:hover .tooltip {
  opacity: 1;
  top: -60px;
}
.notification {
  position: fixed;
  top: 15px;
  right: 15px;
  background: var(--secondary);
  color: white;
  padding: 0.8rem 1.2rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 1001;
}
.notification.active {
  opacity: 1;
}
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.modal-overlay.active {
  opacity: 1;
  pointer-events: auto;
}
.modal-content {
  background: white;
  border-radius: var(--radius);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  max-width: 550px;
  width: 90%;
  padding: 1.5rem;
  max-height: 85vh;
  overflow-y: auto;
  transform: scale(0.7);
  transition: transform 0.3s ease;
}
.modal-overlay.active .modal-content {
  transform: scale(1);
}
.modal-content h2 {
  background: linear-gradient(45deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-align: center;
  margin-bottom: 1rem;
}
.score-card {
  background: rgba(255, 255, 255, 0.95);
  padding: 1rem;
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.feedback-card {
  background: rgba(254, 243, 199, 0.5);
  padding: 1rem;
  border-radius: var(--radius);
  border: 1px solid #fed7aa;
}
@keyframes bubble {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}
@keyframes glow {
  0% { box-shadow: 0 0 8px rgba(37, 99, 235, 0.3); }
  50% { box-shadow: 0 0 16px rgba(37, 99, 235, 0.5); }
  100% { box-shadow: 0 0 8px rgba(37, 99, 235, 0.3); }
}
@media (max-height: 600px) {
  .lab-section, .protocol-section {
    padding: 0.8rem;
  }
  .gel-tray {
    height: 150px;
    width: 240px;
  }
  .tools-grid {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  }
  .step-card {
    padding: 0.8rem;
    margin-bottom: 0.5rem;
  }
}
</style>
</head>
<body>
<div class="container">
<header>
<h1 class="title">مختبر فصل هلام الأغاروز التفاعلي</h1>
  <a href="/static/2.pdf" download class="btn btn-primary" style="text-decoration: none;">
    <i class="fas fa-download"></i> تحميل البروتوكول
  </a>
</header>
<main class="main-grid">
<section class="lab-section">
<h2 class="text-xl font-bold mb-3 text-gray-800">المختبر التفاعلي</h2>
<h3 class="text-base font-semibold mb-2 text-gray-700">المواد</h3>
<div class="tools-grid">
<div class="tool-card" draggable="true">
<i class="fas fa-vial text-xl text-blue-600 mb-1"></i>
<span class="font-medium text-sm">مسحوق الأغاروز</span>
<span class="text-xs text-gray-500">1 جم</span>
<div class="tooltip">
مسحوق الأغاروز لتحضير الهلام، يذوب في المخزن عند التسخين
<div class="mt-1 text-xs text-blue-200">اسحب إلى القالب</div>
</div>
</div>
<div class="tool-card" draggable="true">
<i class="fas fa-tint text-xl text-green-600 mb-1"></i>
<span class="font-medium text-sm">مخزن TAE</span>
<span class="text-xs text-gray-500">100 مل</span>
<div class="tooltip">
محلول مخزن يوفر بيئة موصلة للفصل الكهربائي
</div>
</div>
<div class="tool-card" draggable="true">
<i class="fas fa-syringe text-xl text-purple-600 mb-1"></i>
<span class="font-medium text-sm">صبغة التحميل</span>
<span class="text-xs text-gray-500">5 ميكرولتر</span>
<div class="tooltip">
صبغة تساعد في تحميل العينات وتتبع حركتها في الهلام
</div>
</div>
<div class="tool-card" draggable="true">
<i class="fas fa-dna text-xl text-red-600 mb-1"></i>
<span class="font-medium text-sm">عينة DNA</span>
<span class="text-xs text-gray-500">10 ميكرولتر</span>
<div class="tooltip">
عينة الحمض النووي التي سيتم فصلها
</div>
</div>
<div class="tool-card" draggable="true">
<i class="fas fa-eye-dropper text-xl text-orange-600 mb-1"></i>
<span class="font-medium text-sm">صبغة التصور</span>
<span class="text-xs text-gray-500">1 ميكرولتر</span>
<div class="tooltip">
صبغة (مثل Ethidium Bromide) لتصور أشرطة DNA تحت الأشعة فوق البنفسجية
</div>
</div>
</div>
<h3 class="text-base font-semibold mb-2 text-gray-700">الأجهزة</h3>
<div class="equipment-section">
<div class="flex flex-wrap gap-2">
<button class="btn btn-equipment" id="add-comb-btn" disabled>
<i class="fas fa-tooth"></i>
إضافة مشط الآبار
</button>
<button class="btn btn-equipment" id="connect-device-btn" disabled>
<i class="fas fa-plug"></i>
توصيل جهاز الفصل
</button>
</div>
</div>
<div class="gel-tray">
<div class="gel" id="gel"></div>
</div>
<div class="controls">
<div class="text-center mb-3">
<i class="fas fa-thermometer-half text-red-600 mr-2"></i>
<span class="font-medium text-sm" id="temp-display">درجة الحرارة: 25°C</span>
</div>
<div class="grid grid-cols-2 gap-2">
<button class="btn btn-sample" id="prepare-gel-btn">
<i class="fas fa-flask"></i>
تحضير الخليط
</button>
<button class="btn btn-primary" id="heat-btn" disabled>
<i class="fas fa-fire"></i>
بدء التسخين
</button>
<button class="btn btn-danger" id="stop-heat-btn" disabled>
<i class="fas fa-stop"></i>
إنهاء التسخين
</button>
<button class="btn btn-primary" id="pour-btn" disabled>
<i class="fas fa-fill-drip"></i>
صب الهلام
</button>
<button class="btn btn-primary" id="run-btn" disabled>
<i class="fas fa-bolt"></i>
تشغيل الفصل
</button>
<button class="btn btn-primary" id="analyze-btn" disabled>
<i class="fas fa-chart-bar"></i>
تحليل النتائج
</button>
</div>
</div>
</section>
<aside class="protocol-section">
<h2 class="text-xl font-bold mb-3 text-gray-800">خطوات البروتوكول</h2>
<div class="step-card active-step-1">
<div class="flex items-center gap-2 mb-2">
<div class="step-number">1</div>
<h3 class="text-base font-semibold">تحضير هلام الأغاروز</h3>
</div>
<p class="text-gray-600 text-sm">أضف مسحوق الأغاروز ومخزن TAE، سخن الخليط إلى 70-80°C، ثم اتركه ليبرد إلى ~50°C.</p>
<p class="text-xs text-blue-600 mt-1">تلميح: التسخين يذيب الأغاروز، والتبريد يمنع تلف القالب.</p>
</div>
<div class="step-card">
<div class="flex items-center gap-2 mb-2">
<div class="step-number">2</div>
<h3 class="text-base font-semibold">صب الهلام</h3>
</div>
<p class="text-gray-600 text-sm">أضف صبغة التصور، ضع المشط، ثم صب الخليط في القالب.</p>
<p class="text-xs text-blue-600 mt-1">تلميح: المشط ينشئ آبارًا لتحميل العينات.</p>
</div>
<div class="step-card">
<div class="flex items-center gap-2 mb-2">
<div class="step-number">3</div>
<h3 class="text-base font-semibold">تحميل العينات</h3>
</div>
<p class="text-gray-600 text-sm">أضف صبغة التحميل وعينة DNA إلى الآبار.</p>
<p class="text-xs text-blue-600 mt-1">تلميح: صبغة التحميل تجعل العينات مرئية وتساعد في غمرها.</p>
</div>
<div class="step-card">
<div class="flex items-center gap-2 mb-2">
<div class="step-number">4</div>
<h3 class="text-base font-semibold">تشغيل الفصل الكهربائي</h3>
</div>
<p class="text-gray-600 text-sm">قم بتوصيل جهاز الفصل، شغل التيار، و حلل أشرطة DNA.</p>
<p class="text-xs text-blue-600 mt-1">تلميح: الجزيئات الأصغر تتحرك أسرع في الهلام.</p>
</div>
<div class="flex gap-2 flex-wrap">
<button class="btn btn-back mt-3" id="prev-step-btn" disabled>
<i class="fas fa-arrow-right"></i>
الخطوة السابقة
</button>
<button class="btn btn-primary mt-3" id="next-step-btn" disabled>
الخطوة التالية
<i class="fas fa-arrow-left"></i>
</button>
<button class="btn btn-danger mt-3" id="end-experiment-btn">
إنهاء التجربة
<i class="fas fa-stop"></i>
</button>
</div>
</aside>
</main>
<div class="notification" id="point-notification"></div>
<div class="modal-overlay" id="score-modal">
<div class="modal-content">
<h2 class="text-xl font-bold">تقرير نتائج التجربة</h2>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
<div class="score-card">
<div class="flex items-center gap-2 mb-2">
<i class="fas fa-star text-xl text-red-600"></i>
<h3 class="text-base font-semibold text-gray-700">النتيجة النهائية</h3>
</div>
<p class="text-2xl font-bold text-gray-800" id="final-score">0/20</p>
<p class="font-semibold text-base" id="score-comment"></p>
</div>
<div class="score-card">
<div class="flex items-center gap-2 mb-2">
<i class="fas fa-clock text-xl text-blue-600"></i>
<h3 class="text-base font-semibold text-gray-700">الوقت المستغرق</h3>
</div>
<p class="text-lg text-gray-800 font-medium" id="time-taken">0 دقيقة و 0 ثانية</p>
</div>
</div>
<div class="score-card mb-4">
<div class="flex items-center gap-2 mb-3">
<i class="fas fa-tasks text-xl text-teal-600"></i>
<h3 class="text-base font-semibold text-gray-700">ملخص الأداء</h3>
</div>
<p class="text-xs text-gray-600" id="performance-summary">لم يتم إكمال أي خطوات بشكل صحيح بعد.</p>
</div>
<div class="feedback-card mb-4">
<div class="flex items-center gap-2 mb-2">
<i class="fas fa-lightbulb text-lg text-amber-600"></i>
<h3 class="text-base font-semibold text-amber-700">نصائح للتحسين</h3>
</div>
<ul class="space-y-1 text-xs text-amber-600" id="improvement-tips"></ul>
</div>
<div class="score-card">
<div class="flex items-center gap-2 mb-3">
<i class="fas fa-info-circle text-xl text-blue-600"></i>
<h3 class="text-base font-semibold text-gray-700">معلومات تعليمية</h3>
</div>
<p class="text-xs text-gray-600">فصل هلام الأغاروز يستخدم لفصل جزيئات الحمض النووي بناءً على حجمها. الجزيئات الأصغر تتحرك أسرع عبر الهلام تحت تأثير التيار الكهربائي.</p>
</div>
<div class="flex justify-center">
<button class="btn btn-primary" id="close-modal">إغلاق التقرير</button>
</div>
</div>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // DOM Elements
  const gel = document.getElementById('gel');
  const toolCards = document.querySelectorAll('.tool-card');
  const nextStepButton = document.getElementById('next-step-btn');
  const prevStepButton = document.getElementById('prev-step-btn');
  const endExperimentButton = document.getElementById('end-experiment-btn');
  const prepareGelButton = document.getElementById('prepare-gel-btn');
  const heatButton = document.getElementById('heat-btn');
  const stopHeatButton = document.getElementById('stop-heat-btn');
  const pourButton = document.getElementById('pour-btn');
  const runButton = document.getElementById('run-btn');
  const analyzeButton = document.getElementById('analyze-btn');
  const addCombButton = document.getElementById('add-comb-btn');
  const connectDeviceButton = document.getElementById('connect-device-btn');
  const gelTray = document.querySelector('.gel-tray');
  const scoreModal = document.getElementById('score-modal');
  const closeModalButton = document.getElementById('close-modal');
  const pointNotification = document.getElementById('point-notification');
  const tempDisplay = document.getElementById('temp-display');

  // Validation
  if (!gel) console.error('Element with id "gel" not found');
  if (!nextStepButton) console.error('Element with id "next-step-btn" not found');
  if (!prevStepButton) console.error('Element with id "prev-step-btn" not found');
  if (!endExperimentButton) console.error('Element with id "end-experiment-btn" not found');
  if (!prepareGelButton) console.error('Element with id "prepare-gel-btn" not found');
  if (!heatButton) console.error('Element with id "heat-btn" not found');
  if (!stopHeatButton) console.error('Element with id "stop-heat-btn" not found');
  if (!pourButton) console.error('Element with id "pour-btn" not found');
  if (!runButton) console.error('Element with id "run-btn" not found');
  if (!analyzeButton) console.error('Element with id "analyze-btn" not found');
  if (!addCombButton) console.error('Element with id "add-comb-btn" not found');
  if (!connectDeviceButton) console.error('Element with id "connect-device-btn" not found');
  if (!gelTray) console.error('Element with class "gel-tray" not found');
  if (!scoreModal) console.error('Element with id "score-modal" not found');
  if (!closeModalButton) console.error('Element with id "close-modal" not found');
  if (!pointNotification) console.error('Element with id "point-notification" not found');
  if (!tempDisplay) console.error('Element with id "temp-display" not found');

  // State Variables
  let currentStep = 1;
  let addedTools = [];
  let allAddedTools = [];
  let correctTools = [];
  let controlActions = { prepare: false, heat: false, cool: false, pour: false, addComb: false, connectDevice: false, run: false, analyze: false };
  let startTime = Date.now();
  let isHeating = false;
  let isCooling = false;
  let isRunning = false;
  let temperature = 25;
  let stepHistory = [];
  let errors = [];

  // Step Requirements (only tools, equipment handled separately)
  const stepRequirements = {
    1: ['مسحوق الأغاروز', 'مخزن TAE'],
    2: ['صبغة التصور'],
    3: ['صبغة التحميل', 'عينة DNA'],
    4: [],
  };

  // Timer Function
  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    seconds = seconds % 60;
    return `${minutes} دقيقة و ${seconds} ثانية`;
  }

  // Show Notification
  function showNotification(message, isError = false) {
    pointNotification.textContent = message;
    pointNotification.style.background = isError ? '#ef4444' : '#10b981';
    pointNotification.classList.add('active');
    setTimeout(() => {
      pointNotification.classList.remove('active');
    }, 3000);
  }

  // Update Tool Cards
  function updateToolCards() {
    toolCards.forEach(card => {
      card.classList.remove('disabled');
      card.setAttribute('draggable', true);
      card.addEventListener('dragstart', handleDragStart);
    });
  }

  // Drag and Drop Handlers
  function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.querySelector('span').textContent);
  }

  if (gelTray) {
    gelTray.addEventListener('dragover', e => {
      e.preventDefault();
      e.target.style.animation = 'glow 1.5s infinite';
    });

    gelTray.addEventListener('drop', e => {
      e.preventDefault();
      e.target.style.animation = '';
      const tool = e.dataTransfer.getData('text/plain');
      if (!addedTools.includes(tool)) {
        addedTools.push(tool);
        allAddedTools.push(tool);
        if (stepRequirements[currentStep].includes(tool) && !correctTools.includes(tool)) {
          correctTools.push(tool);
          showNotification(`تم إضافة ${tool} بنجاح! (+1 نقطة)`);
        } else {
          errors.push(`إضافة ${tool} في الخطوة ${currentStep} غير صحيحة`);
          showNotification(`تم إضافة ${tool} لكن لا نقاط لهذه الخطوة`, true);
        }
        updateGel();
        checkStepCompletion();
      }
    });
  }

  // Update Gel Appearance
  function updateGel() {
    if (!gel) return;
    let height = 0;
    let color = '';
    allAddedTools.forEach((tool, index) => {
      switch (tool) {
        case 'مسحوق الأغاروز':
          height += 20;
          color = index === allAddedTools.length - 1 ? 'linear-gradient(to top, #bfdbfe, #dbeafe)' : color;
          break;
        case 'مخزن TAE':
          height += 20;
          color = index === allAddedTools.length - 1 ? 'linear-gradient(to top, #93c5fd, #bfdbfe)' : color;
          break;
        case 'صبغة التصور':
          height += 10;
          color = index === allAddedTools.length - 1 ? 'linear-gradient(to top, #fed7aa, #ffedd5)' : color;
          break;
        case 'صبغة التحميل':
          height += 10;
          color = index === allAddedTools.length - 1 ? 'linear-gradient(to top, #f3e8ff, #e9d5ff)' : color;
          break;
        case 'عينة DNA':
          height += 10;
          color = index === allAddedTools.length - 1 ? 'linear-gradient(to top, #bbf7d0, #86efac)' : color;
          break;
      }
    });
    if (controlActions.addComb) {
      height += 10;
      color = 'linear-gradient(to top, #d1d5db, #e5e7eb)';
    }
    if (controlActions.connectDevice) {
      height += 10;
      color = 'linear-gradient(to top, #5eead4, #99f6e4)';
    }
    height = Math.min(height, 100);
    gel.style.height = `${height}%`;
    gel.style.background = color || 'linear-gradient(to top, #ffffff, #e0e0e0)';
  }

  // Check Step Completion
  function checkStepCompletion() {
    const requiredTools = stepRequirements[currentStep];
    const allToolsAdded = requiredTools.every(tool => correctTools.includes(tool));
    if (currentStep === 1) {
      if (allToolsAdded && controlActions.prepare && controlActions.heat && controlActions.cool) {
        pourButton.removeAttribute('disabled');
        addCombButton.removeAttribute('disabled');
        nextStepButton.removeAttribute('disabled');
      }
    } else if (currentStep === 2) {
      if (allToolsAdded && controlActions.pour && controlActions.addComb) {
        nextStepButton.removeAttribute('disabled');
      }
    } else if (currentStep === 3) {
      if (allToolsAdded) {
        runButton.removeAttribute('disabled');
        connectDeviceButton.removeAttribute('disabled');
        nextStepButton.removeAttribute('disabled');
      }
    } else if (currentStep === 4) {
      if (controlActions.connectDevice && controlActions.run) {
        analyzeButton.removeAttribute('disabled');
        nextStepButton.removeAttribute('disabled');
      }
    }
  }

  // Calculate Score
  function calculateScore() {
    let score = 0;
    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
    
    // Base score: 3 points per completed step
    score += (currentStep - 1) * 3;
    
    // Correct tools: 1 point per correct tool
    score += correctTools.length;
    
    // Control actions
    if (controlActions.prepare) score += 2;
    if (controlActions.heat) score += 2;
    if (controlActions.cool) score += 1;
    if (controlActions.pour) score += 2;
    if (controlActions.addComb) score += 1;
    if (controlActions.connectDevice) score += 1;
    if (controlActions.run) score += 2;
    if (controlActions.analyze) score += 2;
    
    // Time bonus: Up to 3 points for completing in under 5 minutes
    if (elapsedSeconds < 300) {
      score += Math.floor((300 - elapsedSeconds) / 100);
    }
    
    // Penalty for errors
    score -= Math.floor(errors.length / 2);
    
    return Math.max(0, Math.min(score, 20));
  }

  // Generate Performance Summary
  function generatePerformanceSummary() {
    const completedSteps = currentStep - 1;
    const requiredTools = stepRequirements[currentStep];
    const toolsComplete = requiredTools.every(tool => correctTools.includes(tool));
    let summary = '';
    
    if (completedSteps === 0 && !toolsComplete) {
      summary = 'لم يتم إكمال أي خطوات بشكل صحيح بعد.';
    } else {
      summary = `تم إكمال ${completedSteps} من 4 خطوات. `;
      if (toolsComplete || requiredTools.length === 0) {
        summary += 'جميع المواد المطلوبة في الخطوة الحالية تمت إضافتها بنجاح.';
      } else {
        summary += 'الخطوة الحالية لم تكتمل بالكامل.';
      }
      if (controlActions.prepare) summary += ' تم تحضير الخليط بنجاح.';
      if (controlActions.heat) summary += ' تم تسخين الخليط إلى 70-80°C.';
      if (controlActions.cool) summary += ' تم تبريد الخليط إلى ~50°C.';
      if (controlActions.pour) summary += ' تم صب الهلام بشكل صحيح.';
      if (controlActions.addComb) summary += ' تم إضافة مشط الآبار.';
      if (controlActions.connectDevice) summary += ' تم توصيل جهاز الفصل.';
      if (controlActions.run) summary += ' تم تشغيل الفصل الكهربائي بنجاح.';
      if (controlActions.analyze) summary += ' تم تحليل أشرطة DNA بنجاح.';
    }
    if (errors.length > 0) {
      summary += ` لاحظت ${errors.length} أخطاء، مثل إضافة مواد في الخطوة الخاطئة.`;
    }
    return summary;
  }

  // Generate Improvement Tips
  function generateImprovementTips() {
    const tips = [
      'اتبع تسلسل الخطوات بدقة لتجنب الأخطاء.',
      'اقرأ التعليمات والتلميحات بعناية قبل تنفيذ كل خطوة.',
      'تأكد من إضافة المواد في الخطوة الصحيحة.',
      'انتظر حتى تبرد درجة الحرارة إلى ~50°C قبل صب الهلام.',
      'استخدم أزرار التحكم لإضافة الأجهزة في الوقت المناسب.'
    ];
    if (errors.length > 0) {
      tips.push('تجنب إضافة مواد غير مطلوبة في الخطوة الحالية.');
    }
    return tips;
  }

  // Generate Score Comment
  function generateScoreComment(score) {
    if (score >= 16) return { text: 'ممتاز! لقد أتقنت التجربة.', color: 'text-green-600' };
    if (score >= 12) return { text: 'جيد جدًا، لكن يمكن تحسين التسلسل.', color: 'text-blue-600' };
    if (score >= 8) return { text: 'مقبول، ركز على الخطوات بدقة أكبر.', color: 'text-yellow-600' };
    return { text: 'يحتاج إلى تحسين، راجع التعليمات.', color: 'text-red-600' };
  }

  // Show Score Modal
  function showScoreModal() {
    const score = calculateScore();
    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
    const scoreComment = generateScoreComment(score);
    
    document.getElementById('final-score').textContent = `${score}/20`;
    document.getElementById('score-comment').textContent = scoreComment.text;
    document.getElementById('score-comment').className = `font-semibold text-base ${scoreComment.color}`;
    document.getElementById('time-taken').textContent = formatTime(elapsedSeconds);
    document.getElementById('performance-summary').textContent = generatePerformanceSummary();
    
    const tipsList = document.getElementById('improvement-tips');
    tipsList.innerHTML = '';
    generateImprovementTips().forEach(tip => {
      const li = document.createElement('li');
      li.className = 'flex items-start gap-2';
      li.innerHTML = `<span class="font-semibold mt-0.5">•</span>${tip}`;
      tipsList.appendChild(li);
    });
    
    scoreModal.classList.add('active');
  }

  // End Experiment
  if (endExperimentButton) {
    endExperimentButton.addEventListener('click', () => {
      showScoreModal();
      disableInteractions();
    });
  }

  // Disable Interactions
  function disableInteractions() {
    toolCards.forEach(card => {
      card.classList.add('disabled');
      card.setAttribute('draggable', false);
      card.removeEventListener('dragstart', handleDragStart);
    });
    [prepareGelButton, heatButton, stopHeatButton, pourButton, runButton, analyzeButton, addCombButton, connectDeviceButton, nextStepButton, prevStepButton, endExperimentButton].forEach(btn => {
      if (btn) btn.setAttribute('disabled', true);
    });
    if (gelTray) {
      gelTray.removeEventListener('dragover', e => e.preventDefault());
      gelTray.removeEventListener('drop', e => {});
    }
  }

  // Close Modal
  if (closeModalButton) {
    closeModalButton.addEventListener('click', () => {
      scoreModal.classList.remove('active');
    });
  }

  // Prepare Gel Mixture
  if (prepareGelButton) {
    prepareGelButton.addEventListener('click', () => {
      if (currentStep === 1 && !controlActions.prepare) {
        controlActions.prepare = true;
        showNotification('تم تحضير الخليط بنجاح! (+2 نقطة)');
        prepareGelButton.setAttribute('disabled', true);
        if (stepRequirements[1].every(tool => correctTools.includes(tool))) {
          heatButton.removeAttribute('disabled');
          stopHeatButton.removeAttribute('disabled');
        }
      }
    });
  }

  // Heating Control
  let heatInterval;
  if (heatButton) {
    heatButton.addEventListener('click', () => {
      if (currentStep === 1 && !isHeating && controlActions.prepare) {
        isHeating = true;
        heatButton.setAttribute('disabled', true);
        stopHeatButton.removeAttribute('disabled');
        heatInterval = setInterval(() => {
          if (temperature < 80) {
            temperature += 2;
            tempDisplay.textContent = `درجة الحرارة: ${temperature}°C`;
          }
          if (temperature >= 70 && !controlActions.heat) {
            showNotification('تم الوصول إلى درجة الحرارة المطلوبة 70-80°C! (+2 نقطة)');
            controlActions.heat = true;
            // Start cooling automatically
            clearInterval(heatInterval);
            isHeating = false;
            isCooling = true;
            heatButton.setAttribute('disabled', true);
            stopHeatButton.setAttribute('disabled', true);
            setTimeout(() => {
              const coolInterval = setInterval(() => {
                if (temperature > 50) {
                  temperature -= 2;
                  tempDisplay.textContent = `درجة الحرارة: ${temperature}°C`;
                }
                if (temperature <= 50) {
                  clearInterval(coolInterval);
                  isCooling = false;
                  controlActions.cool = true;
                  showNotification('تم تبريد الخليط إلى ~50°C! (+1 نقطة)');
                  checkStepCompletion();
                }
              }, 1000);
            }, 2000);
          }
        }, 1000);
      }
    });
  }

  if (stopHeatButton) {
    stopHeatButton.addEventListener('click', () => {
      if (currentStep === 1 && isHeating) {
        isHeating = false;
        clearInterval(heatInterval);
        heatButton.removeAttribute('disabled');
        stopHeatButton.setAttribute('disabled', true);
        showNotification('تم إيقاف التسخين قبل الوصول إلى درجة الحرارة المطلوبة', true);
        errors.push('إيقاف التسخين مبكرًا');
      }
    });
  }

  // Pour Gel
  if (pourButton) {
    pourButton.addEventListener('click', () => {
      if (currentStep === 2 && controlActions.cool && temperature <= 55 && temperature >= 45) {
        controlActions.pour = true;
        showNotification('تم صب الهلام بنجاح! (+2 نقطة)');
        pourButton.setAttribute('disabled', true);
        if (gel) {
          gel.style.height = '80%';
          gel.style.background = 'linear-gradient(to top, #e0e0e0, #ffffff)';
        }
        checkStepCompletion();
      } else {
        errors.push('محاولة صب الهلام عند درجة حرارة غير مناسبة');
        showNotification('درجة الحرارة غير مناسبة لصب الهلام (يجب أن تكون ~50°C)', true);
      }
    });
  }

  // Add Comb
  if (addCombButton) {
    addCombButton.addEventListener('click', () => {
      if (currentStep === 2 && !controlActions.addComb) {
        controlActions.addComb = true;
        showNotification('تم إضافة مشط الآبار بنجاح! (+1 نقطة)');
        addCombButton.setAttribute('disabled', true);
        updateGel();
        checkStepCompletion();
      }
    });
  }

  // Connect Device
  if (connectDeviceButton) {
    connectDeviceButton.addEventListener('click', () => {
      if (currentStep === 4 && !controlActions.connectDevice) {
        controlActions.connectDevice = true;
        showNotification('تم توصيل جهاز الفصل بنجاح! (+1 نقطة)');
        connectDeviceButton.setAttribute('disabled', true);
        updateGel();
        checkStepCompletion();
      }
    });
  }

  // Run Electrophoresis
  let runInterval;
  if (runButton) {
    runButton.addEventListener('click', () => {
      if (currentStep === 4 && !isRunning && controlActions.connectDevice) {
        isRunning = true;
        runButton.setAttribute('disabled', true);
        if (gel) gel.style.animation = 'bubble 0.5s infinite';
        runInterval = setTimeout(() => {
          showNotification('تم تشغيل الفصل الكهربائي بنجاح! (+2 نقطة)');
          controlActions.run = true;
          if (gel) gel.style.animation = '';
          checkStepCompletion();
        }, 3000);
      }
    });
  }

  // Analyze Results
  if (analyzeButton) {
    analyzeButton.addEventListener('click', () => {
      if (currentStep === 4 && controlActions.run) {
        controlActions.analyze = true;
        showNotification('تم تحليل أشرطة DNA بنجاح! (+2 نقطة)');
        if (gel) {
          gel.style.background = 'linear-gradient(to top, #86efac, #bbf7d0)';
          gel.style.height = '100%';
        }
        showNotification('تهانينا! لقد ظهرت أشرطة DNA تحت الأشعة فوق البنفسجية.');
      }
    });
  }

  // Next Step
  if (nextStepButton) {
    nextStepButton.addEventListener('click', () => {
      const requiredTools = stepRequirements[currentStep];
      const allToolsAdded = requiredTools.every(tool => correctTools.includes(tool));
      let canProceed = false;
      
      if (currentStep === 1 && allToolsAdded && controlActions.prepare && controlActions.heat && controlActions.cool) {
        canProceed = true;
      } else if (currentStep === 2 && allToolsAdded && controlActions.pour && controlActions.addComb) {
        canProceed = true;
      } else if (currentStep === 3 && allToolsAdded) {
        canProceed = true;
      } else if (currentStep === 4 && controlActions.connectDevice && controlActions.run && controlActions.analyze) {
        canProceed = true;
      }
      
      if (canProceed && currentStep < 4) {
        stepHistory.push({ step: currentStep, addedTools: [...addedTools], correctTools: [...correctTools], controlActions: { ...controlActions } });
        currentStep++;
        addedTools = [];
        prevStepButton.removeAttribute('disabled');
        updateStepUI();
      } else if (canProceed && currentStep === 4) {
        showScoreModal();
        disableInteractions();
      } else {
        showNotification('يرجى إكمال جميع الإجراءات والمواد المطلوبة لهذه الخطوة!', true);
      }
    });
  }

  // Previous Step
  if (prevStepButton) {
    prevStepButton.addEventListener('click', () => {
      if (currentStep > 1 && stepHistory.length > 0) {
        const prevState = stepHistory.pop();
        currentStep = prevState.step;
        addedTools = prevState.addedTools;
        correctTools = prevState.correctTools;
        controlActions = prevState.controlActions;
        updateStepUI();
        if (stepHistory.length === 0) {
          prevStepButton.setAttribute('disabled', true);
        }
      }
    });
  }

  // Update Step UI
  function updateStepUI() {
    if (allAddedTools.length > 0 || controlActions.addComb || controlActions.connectDevice) {
      updateGel();
    } else if (gel) {
      gel.style.height = '0%';
      gel.style.background = '';
      gel.style.animation = '';
    }
    document.querySelectorAll('.step-card').forEach((card, index) => {
      card.classList.remove('active-step-1', 'active-step-2', 'active-step-3', 'active-step-4');
      if (index + 1 === currentStep) {
        card.classList.add(`active-step-${currentStep}`);
      }
    });
    [prepareGelButton, heatButton, stopHeatButton, pourButton, runButton, analyzeButton, addCombButton, connectDeviceButton].forEach(btn => {
      if (btn) btn.setAttribute('disabled', true);
    });
    if (currentStep === 1) {
      if (!controlActions.prepare) prepareGelButton.removeAttribute('disabled');
      if (controlActions.prepare && stepRequirements[1].every(tool => correctTools.includes(tool))) {
        heatButton.removeAttribute('disabled');
        stopHeatButton.removeAttribute('disabled');
      }
    } else if (currentStep === 2) {
      if (controlActions.cool && stepRequirements[2].every(tool => correctTools.includes(tool))) {
        pourButton.removeAttribute('disabled');
        addCombButton.removeAttribute('disabled');
      }
    } else if (currentStep === 3) {
      if (stepRequirements[3].every(tool => correctTools.includes(tool))) {
        runButton.removeAttribute('disabled');
        connectDeviceButton.removeAttribute('disabled');
      }
    } else if (currentStep === 4) {
      if (controlActions.connectDevice) {
        runButton.removeAttribute('disabled');
      }
      if (controlActions.run) analyzeButton.removeAttribute('disabled');
    }
    const requiredTools = stepRequirements[currentStep];
    if ((requiredTools.every(tool => correctTools.includes(tool)) || requiredTools.length === 0)) {
      checkStepCompletion();
    } else {
      nextStepButton.setAttribute('disabled', true);
    }
    if (!controlActions.cool) {
      temperature = 25;
      tempDisplay.textContent = `درجة الحرارة: ${temperature}°C`;
    }
    isHeating = false;
    isRunning = false;
    updateToolCards();
  }

  // Initialize
  updateToolCards();
});
</script>
</body>
</html>